<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://bitcoincore.tech/apps/bitcoinjs-ui/lib/bitcoinjs-lib.js"></script>
    <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
    <script src="https://bundle.run/bip39@3.0.4"></script>
    <script src="https://bundle.run/bip32@2.0.6"></script>
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <title>MeShell</title>
    <link href="styles.css" rel="stylesheet"></link>
</head>
<body>
    <script>
        var relay = 'wss://relay.cryptocculture.com'
        var socket = new WebSocket( relay );
        var pubKey = localStorage.getItem("pubKey");
        var privKey = localStorage.getItem("privKey");
        var { getSharedSecret, schnorr, utils } = nobleSecp256k1;
        var crypto  = window.crypto ;
        var getRand = size => crypto.getRandomValues(new Uint8Array(size));
        var sha256  = bitcoinjs.crypto.sha256;
        var keypair = bitcoinjs.ECPair.makeRandom();

        function connectedSubbed() {
            socket.addEventListener('open', function( event ) {
                console.log( "connected to " + relay )
                console.log("Your Public Key: " + pubKey);
                console.log("Your Private Key: " + privKey);
                
                var subId = bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" );
                var filterMe = { "authors": [ pubKey ] };
                var subscriptionMe = [ "REQ", subId, filterMe ];

                subscriptionMe = JSON.stringify( subscriptionMe );
                sessionStorage.subscriptionMe = subscriptionMe;
                socket.send( sessionStorage.subscriptionMe );
                console.log(subscriptionMe);

                const sendNote = document.getElementById('makeNoteButton');
                sendNote.innerHTML = `<button id="publish-text-button" onclick="makeNote(document.getElementById('publish-textarea').value)">Publish</button>`;


            })
        }

        function hexToBytes( hex ) {
	        return Uint8Array.from( hex.match( /.{1,2}/g ).map( ( byte ) => parseInt( byte, 16 ) ) );
	    }

	    function bytesToHex( bytes ) {
	        return bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, '0' ), '' );
	    }

	    function base64ToHex( str ) {
	        var raw = atob( str );
	        var result = '';
	        var i; for ( i=0; i<raw.length; i++ ) {
	            var hex = raw.charCodeAt( i ).toString( 16 );
	            result += ( hex.length === 2 ? hex : '0' + hex );
	        }
	        return result;
	    }

        function encrypt( privkey, pubkey, text ) {
            var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
            var iv = window.crypto.getRandomValues(new Uint8Array(16));
            var cipher = browserifyCipher.createCipheriv( 'aes-256-cbc', hexToBytes( key ), iv );
            var encryptedMessage = cipher.update(text,"utf8","base64");
            emsg = encryptedMessage + cipher.final( "base64" );
            var uint8View = new Uint8Array( iv.buffer );
            var decoder = new TextDecoder();
            return emsg + "?iv=" + btoa( String.fromCharCode.apply( null, uint8View ) );
        }

        function decrypt( privkey, pubkey, ciphertext ) {
            var [ emsg, iv ] = ciphertext.split( "?iv=" );
            var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
            var decipher = browserifyCipher.createDecipheriv(
                'aes-256-cbc',
                hexToBytes( key ),
                hexToBytes( base64ToHex( iv ) )
            );
            var decryptedMessage = decipher.update( emsg, "base64" );
            dmsg = decryptedMessage + decipher.final( "utf8" );
            return dmsg;
        }

        function message() {
            socket.addEventListener('message', async function( message ) {
                var [ type, subId, event ] = JSON.parse( message.data );
                var { kind, content } = event || {}
                if (!event) return
                    console.log('message:', event)
                if (kind === 4) {
                    content = decrypt(privKey, pubKey, content)
                }
                console.log('content:', content)
            })
        }
        connectedSubbed();
        message();
    </script>

    <img id="HomeLogo" 
        src="/assets/MeShell_Logo_200_blank.png" 
        alt="MeShell Logo" 
        title="Michel" 
        width="150px">

    <div class="feed-selector">
        <img id="first-edition-logo"
            src="/assets/firstedition.png"
            title="First Edition">
        <br>
        <img id="global-logo"
            src="/assets/global.png"
            title="Global Chat">
            <br>
        <img id="messages-logo"
            src="/assets/message-logo.png"
            title="Direct Messages">
        <br>
        <button id="publish-button">
            <img class="publish-logo"
            src="/assets/publish.png"
            title="Publish">
        </button>
    </div>
    <div id="publish-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <textarea id="publish-textarea" 
                    name="publish-text"
                    rows="15"
                    autocomplete="off"
                    autocapitalize="on"
                    placeholder="Say something to the world"></textarea>
            <br>
            <div id="padding-button"></div>
            <div id="makeNoteButton">
            <button id="publish-text-button" onclick="makeNote(document.getElementById('publish-textarea').value)">
                Publish
            </button>
            </div>
            <script>
                function makeNote( note ) {
                    console.log( "note: '" + note + "'" );
                    var now = Math.floor( ( new Date().getTime() ) / 1000 );
                    console.log( now );
                    var newevent = [
                            0,
                            pubKey,
                            now,
                            1,
                            [],
                            note
                    ];
                    var message = JSON.stringify( newevent );
                    console.log( "message: '" + message + "'" );
                    var msghash = bitcoinjs.crypto.sha256( message ).toString( 'hex' );
                    console.log( "msghash: '" + msghash + "'" );
                    nobleSecp256k1.schnorr.sign( msghash, privKey ).then( 
                            value => { 
                                    sig = value;
                                    console.log( "the sig is:", sig );
                                    nobleSecp256k1.schnorr.verify( 
                                            sig,
                                            msghash,
                                            pubKey
                                    ).then(
                                            value => { 
                                                    console.log( "is the signature valid for the above pubkey over the message 'test'?", value );
                                                    if ( value ) {
                                                            var fullevent = {
                                                                    "id": msghash,
                                                                    "pubkey": pubKey,
                                                                    "created_at": now,
                                                                    "kind": 1,
                                                                    "tags": [],
                                                                    "content": note,
                                                                    "sig": sig
                                                            }
                                                            var sendable = [ "EVENT", fullevent ];
                                                            sessionStorage.sendable = JSON.stringify( sendable );
                                                            socket.send( '["EVENT",' + JSON.stringify( JSON.parse( sessionStorage.sendable )[ 1 ] ) + ']' );
                                                    }
                                            }
                                );
                            }
                    );
                }
            </script>
        </div>
        <script>
            var modal = document.getElementById("publish-modal");
            var btn = document.getElementById("publish-button");
            var span = document.getElementsByClassName("close")[0];
            var text = document.getElementById('publish-textarea');

            btn.onclick = function() {
            modal.style.display = "block";
            }

            span.onclick = function() {
            modal.style.display = "none"
            document.getElementById('publish-textarea').value = '';
            }

            window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                document.getElementById('publish-textarea').value = '';
            }
            }
        </script>
    </div>
    <div class="articles">
        
    </div>
    <div class="right-section">
        <div>
            <img id="search-logo"
                src="/assets/search-logo.png">
        </div>
        <div id="input-pubkey">
            <input type="text" autocomplete="off" placeholder="enter public key to search">
        </div>
    </div>
</body>
</html>