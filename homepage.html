<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://bitcoincore.tech/apps/bitcoinjs-ui/lib/bitcoinjs-lib.js"></script>
    <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
    <title>MeShell</title>
    <link href="styles.css" rel="stylesheet"></link>
</head>
<body>
    <script>
        var relay = 'wss://relay.cryptocculture.com'
        var socket = new WebSocket( relay );
        var pubKey = localStorage.getItem("pubKey");
        var privKey = localStorage.getItem("privkey");
        var { getSharedSecret, schnorr, utils } = nobleSecp256k1;
        var crypto  = window.crypto ;
        var getRand = size => crypto.getRandomValues(new Uint8Array(size));
        var sha256  = bitcoinjs.crypto.sha256;
        var keypair = bitcoinjs.ECPair.makeRandom();

        var subId = bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" );
        var filterMe = { "authors": [ pubKey ] }

        function connectedSubbed() {
            socket.addEventListener('open', async function( e ) {
                console.log( "connected to " + relay )
            
                var subscription = [ "REQ", subId, filterMe ]

                socket.send(JSON.stringify( subscription ));
                console.log('Subscription:', subscription)
            })
        }

        function hexToBytes( hex ) {
	        return Uint8Array.from( hex.match( /.{1,2}/g ).map( ( byte ) => parseInt( byte, 16 ) ) );
	    }

	    function bytesToHex( bytes ) {
	        return bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, '0' ), '' );
	    }

	    function base64ToHex( str ) {
	        var raw = atob( str );
	        var result = '';
	        var i; for ( i=0; i<raw.length; i++ ) {
	            var hex = raw.charCodeAt( i ).toString( 16 );
	            result += ( hex.length === 2 ? hex : '0' + hex );
	        }
	        return result;
	    }

        function encrypt( privkey, pubkey, text ) {
            var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
            var iv = window.crypto.getRandomValues(new Uint8Array(16));
            var cipher = browserifyCipher.createCipheriv( 'aes-256-cbc', hexToBytes( key ), iv );
            var encryptedMessage = cipher.update(text,"utf8","base64");
            emsg = encryptedMessage + cipher.final( "base64" );
            var uint8View = new Uint8Array( iv.buffer );
            var decoder = new TextDecoder();
            return emsg + "?iv=" + btoa( String.fromCharCode.apply( null, uint8View ) );
        }

        function decrypt( privkey, pubkey, ciphertext ) {
            var [ emsg, iv ] = ciphertext.split( "?iv=" );
            var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
            var decipher = browserifyCipher.createDecipheriv(
                'aes-256-cbc',
                hexToBytes( key ),
                hexToBytes( base64ToHex( iv ) )
            );
            var decryptedMessage = decipher.update( emsg, "base64" );
            dmsg = decryptedMessage + decipher.final( "utf8" );
            return dmsg;
        }

        function message() {
            socket.addEventListener('message', async function( message ) {
                var [ type, subId, event ] = JSON.parse( message.data );
                var { kind, content } = event || {}
                if (!event) return
                    console.log('message:', event)
                if (kind === 4) {
                    content = decrypt(privKey, pubKey, content)
                }
                console.log('content:', content)
            })
        }
        connectedSubbed();
        message();
    </script>

    <img id="HomeLogo" 
        src="/assets/MeShell_Logo_200_blank.png" 
        alt="MeShell Logo" 
        title="Michel" 
        width="150px">

    <div class="feed-selector">
        <img id="first-edition-logo"
            src="/assets/firstedition.png"
            title="First Edition">
        <br>
        <img id="global-logo"
            src="/assets/global.png"
            title="Global Chat">
            <br>
        <img id="messages-logo"
            src="/assets/message-logo.png"
            title="Direct Messages">
        <br>
        <button id="publish-button">
            <img class="publish-logo"
            src="/assets/publish.png"
            title="Publish">
        </button>
    </div>
    <div id="publish-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <textarea id="publish-textarea" 
                    name="publish-text"
                    rows="15"
                    autocomplete="off"
                    autocapitalize="on"
                    placeholder="Say something to the world"></textarea>
            <br>
            <div id="padding-button"></div>
            <button id="publish-text-button" onclick="publish()">
                Publish
            </button>
            <script>
                function publish () {

                    var publishTextArea = document.getElementById('publish-textarea');
                    var contentPublish = publishTextArea.value;
                    var eventId = bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" );
                    console.log(contentPublish);

                    var event = {
                            "content"    : contentPublish,
                            "created_at" : Math.floor( Date.now() / 1000 ),
                            "kind"       : 1,
                            "tags"       : [],
                            "pubkey"     : pubKey,
                        };

                    socket.addEventListener('publish', async function( e ) {
                        var signedEvent = await getSignedEvent(event, privKey);
		                console.log('signedEvent:', signedEvent);
		                socket.send(JSON.stringify([ "EVENT", signedEvent ]));
                    })
                }

                async function getSignedEvent(event, privKey) {
                    var eventData = JSON.stringify([
                        0,                    // Reserved for future use
                        event['pubKey'],        // The sender's public key
                        event['created_at'],    // Unix timestamp
                        event['kind'],        // Message “kind” or type
                        event['tags'],        // Tags identify replies/recipients
                        event['content']        // Your note contents
                    ])
                    event.id  = sha256( eventData ).toString( 'hex' )
                    event.sig = await schnorr.sign( event.id, privKey ) 
                    return event
                }
            </script>
        </div>
        <script>
            var modal = document.getElementById("publish-modal");
            var btn = document.getElementById("publish-button");
            var span = document.getElementsByClassName("close")[0];
            var text = document.getElementById('publish-textarea');

            btn.onclick = function() {
            modal.style.display = "block";
            }

            span.onclick = function() {
            modal.style.display = "none"
            document.getElementById('publish-textarea').value = '';
            }

            window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                document.getElementById('publish-textarea').value = '';
            }
            }
        </script>
    </div>
    <div class="articles">
        
    </div>
    <div class="right-section">
        <div>
            <img id="search-logo"
                src="/assets/search-logo.png">
        </div>
        <div id="input-pubkey">
            <input type="text" autocomplete="off" placeholder="enter public key to search">
        </div>
    </div>
</body>
</html>